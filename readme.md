## Monitoring Cluster
1. Create new cluster
```
cd eks
terraform init
terraform plan -target=module.eks_cluster
terraform apply -target=module.eks_cluster
```
2. Apply addons
```
terraform plan -target=module.eks_blueprints_kubernetes_addons
terraform apply -target=module.eks_blueprints_kubernetes_addons
```
3. Copy the oidc value generated by the cluster on iam/main.tf
```
cd iam
terraform init
terraform plan
terraform apply
```
4. After the new cluster and role are created, we proceed with the apply of the service account and secret
```
cd iam/service_accounts
kubectl -n monitoring create secret generic thanos-objstore-config --from-file=thanos.yaml
kubectl apply -f thanos-role.yaml -n monitoring
```

> **Note:** is not posible to separate the creation of the *monitoring* namespace from the addons, you might need to restart the prometheus pod after the apply of the service accounts. Ref: https://github.com/aws-ia/terraform-aws-eks-blueprints/blob/main/modules/kubernetes-addons/kube-prometheus-stack/main.tf#L6

5. Once we have our secret and service account config in place, we can run the apply of our charts
```
cd eks
terraform plan -target=helm_release.thanos
terraform apply -target=helm_release.thanos
```

### Thanos Query and Grafana
```
kubectl port-forward --namespace monitoring svc/thanos-query 9090:9090 & 
kubectl port-forward --namespace monitoring svc/kube-prometheus-stack-grafana 31080:80
```
    
